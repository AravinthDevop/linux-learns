#### aws-instance-custom-cloudwatch-logs.md

----

**Process**

Use cloudwatch agents when the nginx web server generates logs that are forwarded to the cloudwatch log group. If an error is generated by nginx, the lambda function should capture it and store it in an S3 bucket.

**Requirements**

| RESOURCE | INTEGRATION |
|---|---|
| ec2 instance | Required |
| lambda | Required |
| cloud watch | Required |
| s3 | Required |


**Action**

* Attaching an IAM Role to instance
* Install CloudWatch Logs Agent
* Configure CloudWatch Logs Agent

**IAM Role**

```json
{
    "Version": "2012-10-17",
    "Statement": [{
        "Effect": "Allow",
        "Action": [
            "logs:CreateLogGroup",
            "logs:CreateLogStream",
            "logs:PutLogEvents",
            "logs:DescribeLogStreams"
        ],
        "Resource": [
            "arn:aws:logs:*:*:*"
        ]
    }]
}

```

**Install CloudWatch Logs Agent**

```bash
sudo apt update
sudo apt install curl -y
curl https://s3.amazonaws.com/aws-cloudwatch/downloads/latest/awslogs-agent-setup.py -O
python3 ./awslogs-agent-setup.py --region ap-south-1
```

**Install nginx**

```bash
sudo apt update
sudo apt install nginx -y
sudo systemctl start nginx
sudo systemctl enable nginx
```

**How to trigger the nginx logs**


```bash
# open a terminal, connect to an SSH session, and run the command to generate logs.
for i in {1..1000}; do curl -o /dev/null -s -w "%{http_code}\n" http://locahost; sleep 2; done
```

```bash
# open a terminal, connect to an SSH session, and run the command to check access logs.
tail -f /var/log/nginx/access.log
```

**Configure CloudWatch Logs Agent**

Edit /var/awslogs/etc/awslogs.conf file which will have default log path 

```bash
[/var/log/nginx/access.log]
datetime_format = %d/%b/%Y:%H:%M:%S %z
file = /var/log/nginx/access.log
buffer_duration = 5000
log_stream_name = access.log
initial_position = end_of_file
log_group_name = /ec2/nginx/logs

[/var/log/nginx/error.log]
datetime_format = %Y/%m/%d %H:%M:%S
file = /var/log/nginx/error.log
buffer_duration = 5000
log_stream_name = error.log
initial_position = end_of_file
log_group_name = /ec2/nginx/logs
```

restart cloudwatch agent**

After making changes, restart the cloudwatch agent on the ecw instance.

```bash
sudo systemctl restart awslogs
```

**cloudwatch logs**

When logs are created, the ec2 instance's cloudwatch agent automatically pushes them to the cloudwatch logs group. we can get it from cloudwatch log group.

![image](https://user-images.githubusercontent.com/57703276/165018504-9b2d1781-c524-4262-ad86-1a4590945e86.png)

**cloudwatch stream**

![image](https://user-images.githubusercontent.com/57703276/165018765-48f54378-9925-4504-8767-2661c0b9a4c6.png)





